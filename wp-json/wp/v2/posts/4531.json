{"id":4531,"date":"2023-07-25T22:43:39","date_gmt":"2023-07-25T17:13:39","guid":{"rendered":"https:\/\/newwebsite.nestdigital.com\/?p=4531"},"modified":"2023-08-05T16:39:37","modified_gmt":"2023-08-05T11:09:37","slug":"understanding-diffusion-stable-diffusion-in-ai","status":"publish","type":"post","link":"https:\/\/nestdigital.com\/blogs\/understanding-diffusion-stable-diffusion-in-ai\/","title":{"rendered":"Understanding Diffusion And Stable Diffusion in AI"},"content":{"rendered":"\n<p id=\"a86e\">After the Generative Adversal Networks (GANs), Variational Auto Encoders (VAE), and Flow-based models, Diffusion Models are the latest research in generative models that can generate diverse high-resolution images. These models also attracted a lot of attention after OpenAI, Google, and Nvidia trained large-scale models. Some examples of pre-trained architecture on Diffusion are DALLE-2, GLIDE, Imagen, etc.<\/p>\n\n\n\n<h1 class=\"wp-block-heading\" id=\"9f7c\">Main Principle behind Diffusion<\/h1>\n\n\n\n<p id=\"07d3\">Diffusion model logic is inspired by non-equilibrium thermodynamics. They define a Markov chain process to add a Gaussian noise slowly to the data and then learn to reverse the diffusion steps to construct the desired data from the noise.<\/p>\n\n\n\n<p id=\"a657\">For e.g.,&nbsp;<strong>A fixes noising process gradually noises the data x\u2080 to noise x\u209c. We learn to reverse it from noise x\u209c to data x\u2080.<\/strong><\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:1400\/1*ncZsbhWTW_BpHRaEAH2dlQ.png\" alt=\"\"\/><figcaption class=\"wp-element-caption\">Originally created by Author<\/figcaption><\/figure>\n\n\n\n<p id=\"759b\">You can see the code for adding gaussian noise to the image at this&nbsp;<a href=\"https:\/\/gist.github.com\/AtriSaxena\/06aef7904f4aca9f5a6056c3a8fdd484\" rel=\"noreferrer noopener\" target=\"_blank\">gist<\/a>.<\/p>\n\n\n\n<p id=\"73b7\">The idea behind is we add a fixed gaussian noise in a very small amount for series of T steps this is called the&nbsp;<strong>Forward pass<\/strong>. Notably, this is unrelated to the forward pass of the neural network.<\/p>\n\n\n\n<p id=\"090b\">After the neural network is trained to learn the reverse process, i.e., denoise the image to recover the original data. This is so-called the&nbsp;<strong>reverse diffusion process<\/strong>&nbsp;or sampling process of generative models.<\/p>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"3832\">Forward process<\/h2>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:924\/1*GpJs3IdvVAFMFCg7t4_HQg.png\" alt=\"\"\/><figcaption class=\"wp-element-caption\">Originally created by Author<\/figcaption><\/figure>\n\n\n\n<p id=\"b8e0\">Now, a fixed Markov Chain is used to add a Gaussian noise with variance \u03b2\u209c and q is the posterior probability of x\u209c given x\u209c\u208b\u2081. This process can be formulated as below:<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:900\/1*MFpGkW8ZhXfLy2jiKqQcmA.png\" alt=\"\"\/><\/figure>\n\n\n\n<p id=\"57cc\">Since we are in the multi-dimensional scenario here&nbsp;<strong>I<\/strong>&nbsp;is the identity matrix, and it indicates that each dimension has the same standard deviation \u03b2\u209c. Note that, q(x\u209c | x\u209c\u208b\u2081) is still a normal distribution with mean \u03bc\u209c<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:434\/1*2-6wKNNIckr8HJsJoj7f4g.png\" alt=\"\"\/><\/figure>\n\n\n\n<p id=\"daff\">and variance \u03a3\u209c = \u03b2\u209cI. Thus, we can now go from x\u2080, \u2026, x\u209c\u208b\u2081, x\u209c, \u2026 x(T) in a tractable way. Mathematically this posterior probability will be defined as<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:748\/1*PTmpyrzfreGTX6QCOWDJVQ.png\" alt=\"\"\/><\/figure>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"06b8\"><strong>Reverse Diffusion<\/strong><\/h2>\n\n\n\n<p id=\"fed8\">Now, we need to learn the reverse process i.e, given x\u209c learn to predict x\u209c\u208b\u2081, there posterior probability of q(x\u209c | x\u209c\u208b\u2081). For that, we need to take a parameterized model such as a neural network. Since, we know q(x\u209c | x\u209c\u208b\u2081) will be Gaussian, for small \u03b2\u209c, we can choose p\u2080 to be Gaussian and choose mean and variance as parameters.<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:998\/1*Lf0VPl2N3BZCVCy2f6dGog.png\" alt=\"\"\/><\/figure>\n\n\n\n<p id=\"fca4\">If we apply reverse diffusion to all the time steps T then the formula will become:<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:816\/1*MCCzPA9qWDkr5JW2TkDbUw.png\" alt=\"\"\/><\/figure>\n\n\n\n<p id=\"cdc6\">Now, since we need model to learn the mean \u03bc\u209c and Co-variance \u03a3\u209c to predict the Gaussian parameters for each time step.<\/p>\n\n\n\n<h1 class=\"wp-block-heading\" id=\"af99\">Model Architecture of Stable Diffusion Model<\/h1>\n\n\n\n<p id=\"e5bd\">Since we are talking about the Stable Diffusion model which will be taking text or paragraph of text and trying to create image.<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:1400\/1*0t4a3MoJPCUcFVmfeT5CkQ.png\" alt=\"\"\/><figcaption class=\"wp-element-caption\">Originally created by Author<\/figcaption><\/figure>\n\n\n\n<p id=\"55e7\">Here, Convolutional UNet architecture is used which is having same output shape as input. UNet uses downsampling and Upsampling layers and various other components such as Residual connections, batch or group normalization layers. Now as we need to pass the description text also, this text is converted into tokens and run Transformer on them. Then attend these transformers into UNet.<\/p>\n\n\n\n<p id=\"4c99\">Here the model will take noised image x\u209c at time step t and try to predict the noise in the image because the variance is set fixed we will output only one value per pixel that means model learns the Mean of the Gaussian distribution of the images this is also called&nbsp;<strong>Denoising Score Matching.<\/strong><\/p>\n\n\n\n<h1 class=\"wp-block-heading\" id=\"627b\">Conditional Image Generation: Guided Diffusion<\/h1>\n\n\n\n<p id=\"4416\">An important step of image generation is to add conditions in the sampling process to manipulate the generated samples. This is also referred to as Guided Diffusion.<\/p>\n\n\n\n<p id=\"82fd\">There have been methods to guide the distribution using Image\/Text embeddings into the diffusion in order to guide the generation. Mathematically we can say, the guidance refers to conditioning a prior distribution p(x) with a condition y as a class label or text embeddings resulting in p(x\/y).<\/p>\n\n\n\n<p id=\"c1b3\">For converting a diffusion model to a conditional diffusion model we can add conditioning information y at each diffusion step.<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:922\/1*4Z5Y4dFhEBlZ1Fqmk3PIYw.png\" alt=\"\"\/><\/figure>\n\n\n\n<p id=\"4e2b\">Adding conditioning at each time step may result in excellent samples generation from a text prompt.<\/p>\n\n\n\n<p id=\"d4b1\">In general diffusion models aims to learn \u2207logp\u2080(x\u209c|y). Now adding the guidance scalar term \u2018s\u2019 we have<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:1156\/1*6Pzn-JP6iLHZPU48kh_zLw.png\" alt=\"\"\/><\/figure>\n\n\n\n<p id=\"94ba\">Using this guidance, let\u2019s understand the distinction between classifier and classifier-free guidance.<\/p>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"536c\">Classifier guidance<\/h2>\n\n\n\n<p id=\"f7b4\"><a href=\"https:\/\/arxiv.org\/abs\/1503.03585\" rel=\"noreferrer noopener\" target=\"_blank\">Sohl-Dickstein et al<\/a>. and later&nbsp;<a href=\"https:\/\/arxiv.org\/abs\/2105.05233\" rel=\"noreferrer noopener\" target=\"_blank\">Dhariwal and Nichol<\/a>&nbsp;explained in their paper to use a second model, a classifier&nbsp;<em>f\u03d5<\/em>\u200b(<em>y<\/em>\u2223x\u209c\u200b,<em>t<\/em>), to guide the diffusion towards target class y. For achieving that we can train a classifier&nbsp;<em>f\u03d5<\/em>\u200b(<em>y<\/em>\u2223x\u209c\u200b,<em>t<\/em>) on the noise image x\u209c to predict its class y. Then we can use gradient \u2207logp\u2080(x\u209c|y) to guide for diffusion.<\/p>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"eb4b\">Class-free guidance<\/h2>\n\n\n\n<p id=\"6dbf\">Here&nbsp;<a href=\"https:\/\/openreview.net\/forum?id=qw8AKxfYbI\" rel=\"noreferrer noopener\" target=\"_blank\">Ho &amp; Salimans<\/a>&nbsp;proposed a model without a second classifier model. Here author used a single neural network and train a conditional diffusion model together with the unconditional diffusion model. During training, they set y to class 0 randomly, so that model is exposed to both conditional and unconditional setups.<\/p>\n\n\n\n<h1 class=\"wp-block-heading\" id=\"7c33\">Scaling Up Diffusion Models<\/h1>\n\n\n\n<p id=\"3eab\">The problem with the models we discussed is that these are computationally expensive. And for producing high-quality images, U-Net architecture will be very much expensive. Therefore for producing high-resolution images using diffusion there are two methods: cascade diffusion models and latent diffusion models.<\/p>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"cbe9\">Cascade Diffusion Models<\/h2>\n\n\n\n<p id=\"4a5b\"><a href=\"https:\/\/arxiv.org\/abs\/2106.15282\" rel=\"noreferrer noopener\" target=\"_blank\">Ho et al. 2021<\/a>&nbsp;introduced cascaded models which consist of a pipeline of many sequential diffusion models that generates high-fidelity images. Each model generates a sample with a superior resolution than the previous model. Upsampling layers are used to increase the resolution with the diffusion layer.<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:1400\/1*UwneEqNcyn1OslBYg5AxFg.png\" alt=\"\"\/><figcaption class=\"wp-element-caption\"><em>Cascade diffusion model pipeline. Source: Ho &amp; Saharia et al.<\/em><\/figcaption><\/figure>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"7714\">Stable Diffusion: Latent Diffusion Models<\/h2>\n\n\n\n<p id=\"198e\">In Latent Diffusion Models instead of applying diffusion on high-dimensional data, we project the input to a smaller latent space and then apply diffusion<\/p>\n\n\n\n<p id=\"cd62\"><a href=\"https:\/\/arxiv.org\/abs\/2112.10752\" rel=\"noreferrer noopener\" target=\"_blank\">Rombach et al<\/a>. proposed the idea to use an encoder network to encode the input to a smaller latent representation i.e., z\u209c = g(x\u209c). The main purpose behind using an encoder is to reduce the computation requirement of the diffusion network by reducing the image to a small latent space. Later, diffusion model (U-Net) is applied to generate new data, and decoder network is used to upsample the image to the original resolution.<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:1400\/0*TjpXniuya0R8BdOH.png\" alt=\"\"\/><figcaption class=\"wp-element-caption\"><em>Latent diffusion models. Source:&nbsp;<\/em><a href=\"https:\/\/arxiv.org\/abs\/2112.10752\" rel=\"noreferrer noopener\" target=\"_blank\"><em>Rombach et al<\/em><\/a><\/figcaption><\/figure>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"18e0\">Results<\/h2>\n\n\n\n<p id=\"3aaa\">Some results of the diffusion model generated from&nbsp;<a href=\"https:\/\/stablediffusionweb.com\/#demo\" rel=\"noreferrer noopener\" target=\"_blank\">here<\/a>:<\/p>\n\n\n\n<p id=\"cf44\"><strong>Sample Input 1:<\/strong>&nbsp;\u201cA small cabin on top of a snowy mountain in the style of Disney, artstation.\u201d<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:1398\/1*bkH84HjDWOMBlqB5eTwwyg.png\" alt=\"\"\/><figcaption class=\"wp-element-caption\">Generated from&nbsp;<a href=\"https:\/\/stablediffusionweb.com\/#demo\" rel=\"noreferrer noopener\" target=\"_blank\">https:\/\/stablediffusionweb.com\/#demo<\/a><\/figcaption><\/figure>\n\n\n\n<p id=\"c80b\"><strong>Sample Input 2: \u201c<\/strong>Mechanical robot on Indian road\u201d<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/miro.medium.com\/v2\/resize:fit:1390\/1*22TvJ3D1yKHYTHKlAir71Q.png\" alt=\"\"\/><figcaption class=\"wp-element-caption\">Generated from&nbsp;<a href=\"https:\/\/stablediffusionweb.com\/#demo\" rel=\"noreferrer noopener\" target=\"_blank\">https:\/\/stablediffusionweb.com\/#demo<\/a><\/figcaption><\/figure>\n\n\n\n<p id=\"6ba4\">You can try your own sentences also at&nbsp;<a href=\"https:\/\/stablediffusionweb.com\/#demo\" rel=\"noreferrer noopener\" target=\"_blank\">https:\/\/stablediffusionweb.com\/#demo<\/a><\/p>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"a834\">Summary<\/h2>\n\n\n\n<p id=\"9c61\">Let\u2019s summarize the points, we have learned from diffusion models:<\/p>\n\n\n\n<ul>\n<li>Diffusion models work on applying fixed Gaussian noise to the original image for T time steps this process is known as diffusion.<\/li>\n\n\n\n<li>It has two processes Forward and Reverse diffusion. In reverse diffusion, a model or neural network learns to denoise the image.<\/li>\n\n\n\n<li>We can use an image or text embedding to \u201cguide\u201d the diffusion process.<\/li>\n\n\n\n<li>Cascade and Latent diffusion are two approaches to scale-up models to high resolution.<\/li>\n\n\n\n<li>Cascaded diffusion is a sequential diffusion model that uses upscaling layers to create high-resolution images.<\/li>\n\n\n\n<li>Latent diffusion models apply diffusion in a latent space and are less computationally expensive by using variational autoencoders for upsampling and downsampling.<\/li>\n<\/ul>\n\n\n\n<h2 class=\"wp-block-heading\" id=\"a98f\"><strong>References<\/strong><\/h2>\n\n\n\n<p id=\"5376\">[1] Sohl-Dickstein, Jascha, et al.<a href=\"https:\/\/arxiv.org\/abs\/1503.03585\" rel=\"noreferrer noopener\" target=\"_blank\">&nbsp;Deep Unsupervised Learning Using Nonequilibrium Thermodynamics<\/a>. arXiv:1503.03585, arXiv, 18 Nov. 2015<\/p>\n\n\n\n<p id=\"59fd\">[2] Ho, Jonathan, et al.&nbsp;<a href=\"https:\/\/arxiv.org\/abs\/2006.11239\" rel=\"noreferrer noopener\" target=\"_blank\">Denoising Diffusion Probabilistic Models<\/a>. arXiv:2006.11239, arXiv, 16 Dec. 2020<\/p>\n\n\n\n<p id=\"0f94\">[3] Ho, Jonathan, and Tim Salimans.<a href=\"https:\/\/openreview.net\/forum?id=qw8AKxfYbI\" rel=\"noreferrer noopener\" target=\"_blank\">&nbsp;Classifier-Free Diffusion Guidance<\/a>. 2021. openreview.net<\/p>\n\n\n\n<p id=\"8009\">[4] Nichol, Alex, et al.&nbsp;<a href=\"https:\/\/arxiv.org\/abs\/2112.10741\" rel=\"noreferrer noopener\" target=\"_blank\">GLIDE: Towards Photorealistic Image Generation and Editing with Text-Guided Diffusion Models<\/a>. arXiv:2112.10741, arXiv, 8 Mar. 2022<\/p>\n\n\n\n<p id=\"1536\">[5] Rombach, Robin, et al.&nbsp;<a href=\"https:\/\/arxiv.org\/abs\/2112.10752\" rel=\"noreferrer noopener\" target=\"_blank\">High-Resolution Image Synthesis with Latent Diffusion Models<\/a>. arXiv:2112.10752, arXiv, 13 Apr. 2022<\/p>\n\n\n\n<p id=\"6403\">[6] Ho, Jonathan, et al.&nbsp;<a href=\"https:\/\/arxiv.org\/abs\/2106.15282\" rel=\"noreferrer noopener\" target=\"_blank\">Cascaded Diffusion Models for High Fidelity Image Generation<\/a>. arXiv:2106.15282, arXiv, 17 Dec. 2021<\/p>\n\n\n\n<p id=\"7fb8\">[7] Weng, Lilian.&nbsp;<a href=\"https:\/\/lilianweng.github.io\/posts\/2021-07-11-diffusion-models\/\" rel=\"noreferrer noopener\" target=\"_blank\">What Are Diffusion Models?<\/a>&nbsp;11 July 2021<\/p>\n\n\n\n<p id=\"a5fc\">[8] Das, Ayan. \u201c<a href=\"https:\/\/ayandas.me\/blog-tut\/2021\/12\/04\/diffusion-prob-models.html\" rel=\"noreferrer noopener\" target=\"_blank\">An Introduction to Diffusion Probabilistic Models.<\/a>\u201d Ayan Das, 4 Dec. 2021<\/p>\n\n\n\n<p id=\"13ed\">[9] Prafulla Dhariwal. \u201c<a href=\"https:\/\/www.youtube.com\/watch?v=xYJEvihz3OI\" rel=\"noreferrer noopener\" target=\"_blank\">Generative art using diffusion<\/a>.\u201d<\/p>\n\n\n\n<p id=\"b7b5\">[10] Saharia, Chitwan, et al.&nbsp;<a href=\"https:\/\/arxiv.org\/abs\/2205.11487\" rel=\"noreferrer noopener\" target=\"_blank\">Photorealistic Text-to-Image Diffusion Models with Deep Language Understanding<\/a>. arXiv:2205.11487, arXiv, 23 May 2022<\/p>\n","protected":false},"excerpt":{"rendered":"<p>After the Generative Adversal Networks (GANs), Variational Auto Encoders (VAE), and Flow-based models, Diffusion Models are the latest research in generative models that can generate diverse high-resolution images. These models also attracted a lot of attention after OpenAI, Google, and Nvidia trained large-scale models. Some examples of pre-trained architecture on Diffusion are DALLE-2, GLIDE, Imagen, [&hellip;]<\/p>\n","protected":false},"author":9,"featured_media":5671,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"inline_featured_image":false,"footnotes":"","wds_primary_category":16},"categories":[16],"tags":[42],"blocksy_meta":"","_links":{"self":[{"href":"https:\/\/nestdigital.com\/wp-json\/wp\/v2\/posts\/4531"}],"collection":[{"href":"https:\/\/nestdigital.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/nestdigital.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/nestdigital.com\/wp-json\/wp\/v2\/users\/9"}],"replies":[{"embeddable":true,"href":"https:\/\/nestdigital.com\/wp-json\/wp\/v2\/comments?post=4531"}],"version-history":[{"count":0,"href":"https:\/\/nestdigital.com\/wp-json\/wp\/v2\/posts\/4531\/revisions"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/nestdigital.com\/wp-json\/wp\/v2\/media\/5671"}],"wp:attachment":[{"href":"https:\/\/nestdigital.com\/wp-json\/wp\/v2\/media?parent=4531"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/nestdigital.com\/wp-json\/wp\/v2\/categories?post=4531"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/nestdigital.com\/wp-json\/wp\/v2\/tags?post=4531"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}